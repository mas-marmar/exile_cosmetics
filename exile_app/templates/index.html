<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Exile Cosmetics — Главная</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../static/style/style.css">
</head>
<body>
  <div id="toast"></div>
  <header>
    <div class="logo"><img src="/static/media/logoog.png" alt="logo" class="logo">
    <nav class="navigation">
      <a href="{% url 'search' %}">Поиск</a>
      <a href="index.html">Главное</a>
      <a href="{% url 'catalogue' %}">Каталог</a>
      <a href="#">Корзина</a>
      <button id="loginBtn" class="login-button">Войти</button>
      <div id="loginModal" class="modal">
        <div class="modal-content">
          <span id="closeLogin" class="close">&times;</span>
          <h2>Войти в аккаунт</h2>
          <input type="text" placeholder="Логин или email">
          <input type="password" placeholder="Пароль">
          <button class="submit-btn">Войти</button>
        </div>
      </div>
    </nav>
  </header>
  <div class="banner">
    <div class="banner-content">
      <div class="banner-title">Открой новую лимитированную коллекцию!</div>
      <div class="banner-desc">Уникальные формулы и современные ароматы для тебя.<br> Скидка 50% на первый заказ!</div>
      <a class="banner-btn" id="bannerBuyBtn" href="#">КУПИТЬ СЕЙЧАС</a>
    </div>
    <div class="banner-img-wrap">
      <img src="static/media/orig.webp" alt="Баннер: косметика Exile — натуральный уход" />
    </div>

    <div style="text-align: center; margin: 30px 0;">
      <form method="GET" action="{% url 'search' %}" style="display: inline-block;">
        <input type="text" 
               name="q" 
               placeholder="Поиск товаров..." 
               style="padding: 10px 20px; width: 300px; border: 2px solid #b300aa; border-radius: 25px;">
        <button type="submit" 
                style="padding: 10px 25px; background: #b300aa; color: white; border: none; border-radius: 25px; margin-left: 10px;">
          Найти
        </button>
      </form>
    </div>
  </div>
  
  <h1 class="catalog-title">Новые товары</h1>
  <div class="catalog-grid" id="catalog-grid">
  </div>
  
  <h2 class="reviews-title">Отзывы клиентов</h2>
  <div class="reviews-grid">
    <div class="review-card">
      <h3>Екатерина</h3>
      <p>Очень понравился шампунь Exile! Волосы стали мягкие и послушные уже после первого применения.</p>
    </div>
    <div class="review-card">
      <h3>Камила</h3>
      <p>Гель для душа просто бомба. Запах держится долго, кожа увлажнённая и без раздражений. Рекомендую!</p>
    </div>
    <div class="review-card">
      <h3>Мила</h3>
      <p>Оформление упаковки и качество на высоте. Мыло с углём — мой фаворит. Спасибо Exile!</p>
    </div>
    <div class="review-card">
      <h3>Жумагул</h3>
      <p>Крем для тела прекрасно увлажняет кожу, быстро впитывается и не оставляет жирного блеска. Очень довольна!</p>
    </div>
    <div class="review-card">
      <h3>Сергей</h3>
      <p>Быстрая доставка и отличный сервис. Гель для душа с вишнёй стал постоянным гостем в моей ванной.</p>
    </div>
    <div class="review-card">
      <h3>Мария</h3>
      <p>Порадовал шампунь: волосы стали мягче и появился здоровый блеск. Буду заказывать ещё!</p>
    </div>
  </div>

  <script>
    async function loadProductsFromAdmin() {
      try {
        const response = await fetch('/api/products/');
        
        if (!response.ok) {
          console.warn('API endpoint не доступен, пробуем альтернативные способы...');
          return await loadProductsAlternative();
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Ошибка загрузки продуктов:', error);
        return getDemoProducts();
      }
    }

    async function loadProductsAlternative() {
      try {
        const response = await fetch('/get-products/');
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.warn('Альтернативный способ не сработал');
      }
      
      return getDemoProducts();
    }

    function getDemoProducts() {
      return [
        {
          id: 1,
          name: 'Жидкое мыло',
          description: 'Антибактериальный эффект, защита от бактерий',
          price: '499.00',
          image_url: 'static/media/7.webp'
        },
        {
          id: 2,
          name: 'Бальзам для волос',
          description: 'Питает волосы, делает мягкими',
          price: '699.00',
          image_url: 'static/media/5.webp'
        },
        {
          id: 3,
          name: 'Гель для душа',
          description: 'Кремовая текстура, вишнёвый аромат',
          price: '599.00',
          image_url: 'static/media/4.webp'
        },
        {
          id: 4,
          name: 'Шампунь для волос',
          description: 'Восстанавливает блеск и силу',
          price: '799.00',
          image_url: 'static/media/3.webp'
        }
      ];
    }

    function renderProducts(products) {
      const grid = document.getElementById('catalog-grid');
      
      if (!products || products.length === 0) {
        grid.innerHTML = `
          <div class="no-products">
            <p style="text-align: center; grid-column: 1/-1; color: #666;">
              Товары временно недоступны. Загружаем демо-версию...
            </p>
          </div>
        `;
        
        setTimeout(() => {
          renderProducts(getDemoProducts());
        }, 2000);
        return;
      }
      
      grid.innerHTML = '';
      
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.setAttribute('data-id', product.id);
        
        const imageUrl = product.image_url || product.image || 'static/media/default-product.png';
        
        card.innerHTML = `
          <img src="${imageUrl}" alt="${product.name}" onerror="this.src='static/media/default-product.png'">
          <div class="product-name">${product.name}</div>
          <div class="product-description">${product.description || product.short || ''}</div>
          ${product.price ? `<div class="product-price">${product.price} ₽</div>` : ''}
          <button class="add-to-cart-btn" data-product-id="${product.id}">В корзину</button>
        `;
        
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('add-to-cart-btn')) {
              window.location.href = `/catalogue/?product=${product.id}`;
          }
        });
        
        const addToCartBtn = card.querySelector('.add-to-cart-btn');
        addToCartBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          addToCart(product.id);
        });
        
        grid.appendChild(card);
        
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'opacity 0.3s, transform 0.3s';
          
          requestAnimationFrame(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          });
        }, 100);
      });
    }

    function addToCart(productId) {
      showToast('Товар добавлен в корзину!');
      
      console.log('Добавлен товар ID:', productId);
      
      updateCartCount();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Загружаем продукты из админки...');
      
      const products = await loadProductsFromAdmin();
      renderProducts(products);
      
      document.getElementById('bannerBuyBtn').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/catalogue/'; 
      });
    });

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerHTML = msg;
      toast.className = "show";
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
        setTimeout(() => { toast.style.display = 'none'; }, 400);
      }, 1800);
      toast.style.display = 'block';
    }

    function updateCartCount() {
      const cartCount = parseInt(localStorage.getItem('cartCount') || '0') + 1;
      localStorage.setItem('cartCount', cartCount.toString());
      
      const cartLink = document.querySelector('a[href="#"]');
      if (cartLink && cartCount > 0) {
        cartLink.textContent = `Корзина (${cartCount})`;
      }
    }

    const users = [
      { login: 'pupunya', password: '123', name: 'Админ' },
      { login: 'nepupunya', password: 'qwerty', name: 'Пользователь' }
    ];
    
    const loginBtn = document.getElementById('loginBtn');
    const loginModal = document.getElementById('loginModal');
    const closeLogin = document.getElementById('closeLogin');
    const loginInputs = loginModal.querySelectorAll('input');
    const submitBtn = loginModal.querySelector('.submit-btn');

  </script>
</body>
</html>